---
// PizzaCard.astro

// Definimos la interfaz para que TypeScript no marque errores en las props
interface Props {
  nombre: string;
  ingredientes?: string;
  imagen: string;
  precios?: Record<string, number>; // Objeto con llaves string y valores num√©ricos
  precio?: number;
  detalles?: string;
  regalo?: string;
  promo2x1?: boolean;
  categoria?: string;
  tipo?: string;
  isStepCard?: boolean;
}

const { 
  nombre, 
  ingredientes, 
  imagen, 
  precios, 
  precio, 
  detalles, 
  regalo, 
  promo2x1, 
  categoria,
  tipo,
  isStepCard = false 
} = Astro.props;

const idSafe = nombre.toLowerCase().replace(/\s+/g, '-');
---

<div 
  class={`pizza-card group relative bg-white rounded-[2.5rem] border border-zinc-100 shadow-sm transition-all duration-500 overflow-hidden animate-card-in ${isStepCard ? 'p-1 hover:border-roger-green/50' : 'p-2 hover:shadow-2xl hover:-translate-y-2'}`}
  data-category={categoria}
  data-nombre={nombre}
  data-type={tipo} 
>
  {!isStepCard && (
    <div class="absolute top-6 right-6 z-10 flex flex-col gap-2 items-end">
      {detalles && <span class="bg-roger-green text-white text-[10px] font-bold px-4 py-1.5 rounded-full shadow-lg">{detalles}</span>}
      {promo2x1 && <span class="bg-roger-lime text-white text-[10px] font-black px-4 py-1.5 rounded-full shadow-lg italic tracking-widest">2X1 PROMO</span>}
    </div>
  )}

  <div class={`${isStepCard ? 'h-32' : 'h-64'} relative overflow-hidden rounded-[2.2rem]`}>
    <img src={imagen} alt={nombre} class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-1000" />
    <div class="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
  </div>

  <div class={`${isStepCard ? 'p-4' : 'p-6'} space-y-4`}>
    <div class="text-center">
      <h3 class={`${isStepCard ? 'text-lg' : 'text-3xl'} font-black uppercase italic text-zinc-900 leading-none group-hover:text-roger-green transition-colors`}>
        {nombre}
      </h3>
      {!isStepCard && (
        <p class="text-zinc-400 text-[11px] mt-3 uppercase tracking-widest font-medium leading-relaxed min-h-[32px]">
          {ingredientes}
        </p>
      )}
    </div>

    {regalo && !isStepCard && (
      <div class="bg-roger-green/5 border border-roger-green/10 p-4 rounded-[1.5rem] flex items-center justify-center gap-3">
        <span class="text-xl animate-bounce">üéÅ</span>
        <div class="text-left">
          <p class="text-[9px] font-black text-roger-green uppercase tracking-widest leading-none">Gratis</p>
          <p class="text-zinc-700 font-bold text-xs uppercase">{regalo}</p>
        </div>
      </div>
    )}

    <div class="space-y-3">
      {/* CORRECCI√ìN: Validamos que precios sea un objeto y no sea null */}
      {precios && typeof precios === 'object' && !Array.isArray(precios) ? (
        <div class={`grid ${isStepCard ? 'grid-cols-1' : 'grid-cols-2'} gap-2`}>
          {Object.entries(precios).map(([size, p], index) => (
            <label class="cursor-pointer group/item">
              <input 
                type="radio" 
                name={`size-${idSafe}`} 
                value={p} 
                data-size={size}
                class="hidden peer" 
                checked={index === 0} 
              />
              <div class="bg-zinc-50 border border-zinc-100 rounded-2xl p-3 text-center transition-all peer-checked:bg-roger-green peer-checked:text-white">
                <p class="text-[8px] uppercase font-bold opacity-50">{size}</p>
                <p class="text-sm font-black italic">${p}</p>
              </div>
            </label>
          ))}
        </div>
      ) : (
        precio && (
          <div class="bg-zinc-50 p-4 rounded-2xl border border-zinc-100 flex justify-between items-center px-6">
            <span class="text-[10px] font-black text-zinc-300 uppercase italic tracking-widest">Precio</span>
            <input type="radio" name={`size-${idSafe}`} value={precio} data-size="√önico" class="hidden" checked />
            <span class="text-2xl font-black text-zinc-900 italic tracking-tighter">${precio}</span>
          </div>
        )
      )}
    </div>

    <button class={`add-to-cart-btn relative w-full overflow-hidden ${isStepCard ? 'hidden' : 'bg-roger-green py-5 rounded-[1.8rem]'} text-white font-bold transition-all hover:opacity-90 shadow-xl active:scale-95 group/btn`}>
      <span class="relative z-10 flex items-center justify-center gap-2 uppercase tracking-[0.2em] text-[10px]">
        üõí A√±adir al pedido
      </span>
    </button>
  </div>
</div>

<script>
  const setupCartButtons = () => {
    const buttons = document.querySelectorAll('.add-to-cart-btn');

    buttons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const card = (e.target as HTMLElement).closest('.pizza-card') as HTMLElement;
        if (!card) return;

        const nombre = card.dataset.nombre;
        const selectedRadio = card.querySelector('input[type="radio"]:checked') as HTMLInputElement;
        
        if (selectedRadio) {
          const precio = parseFloat(selectedRadio.value);
          const tam = selectedRadio.dataset.size;

          const producto = {
            nombre: nombre,
            tam: tam,
            precio: precio,
            cantidad: 1
          };

          // CORRECCI√ìN: Uso de (window as any) para evitar errores de TypeScript
          const globalWindow = (window as any);
          if (!globalWindow.cart) globalWindow.cart = [];
          globalWindow.cart.push(producto);

          if (typeof globalWindow.updateCartUI === 'function') {
            globalWindow.updateCartUI();
          }

          const btnText = btn.querySelector('span');
          if (btnText) {
            const originalText = btnText.innerText;
            btnText.innerText = "¬°A√ëADIDO! ‚úÖ";
            setTimeout(() => { btnText.innerText = originalText; }, 1500);
          }
        }
      });
    });
  };

  setupCartButtons();
</script>

<style>
  .animate-card-in {
    animation: cardReveal 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards;
  }
  @keyframes cardReveal {
    from { opacity: 0; transform: translateY(30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
</style>