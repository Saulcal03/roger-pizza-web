---
// src/components/Especialidades.astro
import { menu } from '../data/menu.js';
---

<section id="especiales" class="py-24 bg-zinc-900 relative overflow-hidden">
  <div class="container mx-auto px-6 relative z-10 text-center">
    
    <h3 class="text-white text-5xl md:text-7xl font-black uppercase italic tracking-tighter mb-20 drop-shadow-xl">
      Especialidades <span class="text-emerald-500">Roger</span>
    </h3>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
      {menu.promocionesEspeciales.map(promo => (
        <article class="bg-zinc-800/40 border border-zinc-700/50 p-8 rounded-[3rem] group hover:border-emerald-500 hover:bg-zinc-800/60 transition-all duration-500 hover:-translate-y-2 hover:shadow-2xl hover:shadow-emerald-500/10 flex flex-col">
          
          <div class="mb-6 flex-grow">
            <h4 class="text-white text-3xl font-black uppercase italic mb-3 group-hover:text-emerald-400 transition-colors leading-none">
              {promo.nombre}
            </h4>
            <div class="w-12 h-1 bg-emerald-500 rounded-full mx-auto mb-4 opacity-70"></div>
            <p class="text-zinc-400 text-xs uppercase font-bold tracking-wider leading-relaxed px-2">
              {promo.detalles}
            </p>
          </div>

          <div class="mt-auto">
            <p class="text-white font-black text-4xl mb-6 tracking-tight">
              <span class="text-2xl align-top text-emerald-500 mr-1">$</span>{promo.precio}
            </p>
            
            <button 
              class="open-stations-btn w-full bg-white text-zinc-900 py-4 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-zinc-950 hover:text-white hover:border-zinc-950 border-4 border-transparent transition-all shadow-lg active:scale-95"
              data-nombre={promo.nombre}
              data-precio={promo.precio}
              data-estaciones={promo.nombre.toUpperCase().includes('BARRA') ? 2 : 4}
              data-regalo={promo.regalo}
            >
              Seleccionar Estaciones
            </button>
          </div>
        </article>
      ))}
    </div>
  </div>

  <div id="stations-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
    <div class="bg-white w-full max-w-lg rounded-[3rem] p-8 md:p-10 shadow-2xl relative animate-pop-in border border-zinc-200">
      
      <div class="flex justify-between items-start mb-8 pb-4 border-b border-zinc-100">
        <div class="text-left">
          <h4 id="station-modal-title" class="text-3xl font-black uppercase italic text-zinc-900 leading-none"></h4>
          <p id="station-instruction" class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mt-2 bg-zinc-100 inline-block px-2 py-1 rounded-lg"></p>
        </div>
        <button id="undo-selection" class="bg-red-50 text-red-500 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-red-500 hover:text-white transition-all shadow-sm border border-red-100">
          ⌫ BORRAR
        </button>
      </div>

      <div id="station-slots" class="grid grid-cols-2 gap-4 mb-8"></div>

      <div class="flex items-center gap-2 mb-3 ml-1">
        <div class="w-1 h-4 bg-zinc-900 rounded-full"></div>
        <p class="text-[10px] font-black text-zinc-800 uppercase tracking-widest italic">Menú de Sabores</p>
      </div>
      
      <div class="max-h-64 overflow-y-auto grid grid-cols-2 gap-3 p-3 bg-zinc-50 rounded-[2rem] mb-8 custom-scrollbar border border-zinc-100 inner-shadow">
        {menu.sabores.map(s => (
          <button 
            class="flavor-station-btn relative p-4 bg-white border-2 border-zinc-200 rounded-2xl text-[11px] font-black uppercase italic transition-all duration-200 shadow-sm flex items-center justify-between gap-2 hover:border-zinc-300 active:scale-95" 
            data-name={s.nombre}
          >
            <span class="label-text text-zinc-800 pointer-events-none z-10 text-left leading-tight w-full">
              {s.nombre}
            </span>
            <span class="count-badge hidden bg-black/20 text-white px-2 py-0.5 rounded-md text-[9px] pointer-events-none z-10 shadow-sm">
              0
            </span>
          </button>
        ))}
      </div>

      <div class="flex gap-4 pt-2">
        <button id="close-stations" class="flex-1 py-4 bg-zinc-100 text-zinc-500 rounded-2xl font-black uppercase text-[11px] hover:bg-zinc-200 hover:text-zinc-800 transition-colors">CANCELAR</button>
        <button id="confirm-special" class="flex-[2] py-4 px-8 bg-amber-500 text-white rounded-2xl font-black uppercase text-[11px] tracking-wider opacity-50 pointer-events-none transition-all duration-500 shadow-xl shadow-amber-500/30 border-b-4 border-amber-600 active:border-b-0 active:translate-y-1">CONFIRMAR PEDIDO</button>
      </div>
    </div>
  </div>
</section>

<script is:inline>
  let config = { nombre: '', precio: 0, max: 0, regalo: '', seleccionados: [] };

  // 1. ABRIR MODAL
  document.querySelectorAll('.open-stations-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      config = {
        nombre: btn.dataset.nombre,
        precio: parseFloat(btn.dataset.precio),
        max: parseInt(btn.getAttribute('data-estaciones')),
        regalo: btn.dataset.regalo,
        seleccionados: []
      };
      
      document.getElementById('station-modal-title').innerText = config.nombre;
      document.getElementById('station-instruction').innerText = `Configura tus ${config.max} estaciones`;
      renderSlots();
      document.getElementById('stations-modal').classList.remove('hidden');
    });
  });

  // 2. ACTUALIZAR APARIENCIA DE BOTONES
  function updateFlavorButtonsUI() {
    const counts = {};
    config.seleccionados.forEach(s => counts[s] = (counts[s] || 0) + 1);

    document.querySelectorAll('.flavor-station-btn').forEach(btn => {
      const name = btn.dataset.name;
      const label = btn.querySelector('.label-text');
      const badge = btn.querySelector('.count-badge');

      if (counts[name]) {
        btn.style.backgroundColor = '#10b981'; // emerald-500
        btn.style.borderColor = '#10b981';
        label.style.color = '#FFFFFF';
        badge.classList.remove('hidden');
        badge.innerText = `x${counts[name]}`;
        badge.style.backgroundColor = 'rgba(255,255,255,0.2)';
      } else {
        btn.style.backgroundColor = '#FFFFFF';
        btn.style.borderColor = '#e4e4e7';
        label.style.color = '#27272a';
        badge.classList.add('hidden');
      }
    });
  }

  // 3. RENDERIZAR SLOTS (Los huecos visuales)
  function renderSlots() {
    const container = document.getElementById('station-slots');
    container.innerHTML = '';
    
    for(let i=0; i < config.max; i++) {
      const sabor = config.seleccionados[i];
      const isFilled = !!sabor;
      
      container.innerHTML += `
        <div class="h-20 rounded-2xl border-2 flex flex-col items-center justify-center transition-all duration-300 relative overflow-hidden ${isFilled ? 'bg-amber-500 border-amber-500 shadow-lg shadow-amber-500/20' : 'border-dashed border-zinc-300 bg-zinc-50'}">
          ${isFilled ? '<div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent pointer-events-none"></div>' : ''}
          <span class="text-[8px] font-black uppercase tracking-wider mb-1 ${isFilled ? 'text-amber-900/60' : 'text-zinc-400'}">Estación ${i + 1}</span>
          <span class="text-[11px] font-black uppercase italic text-center px-1 leading-none ${isFilled ? 'text-white drop-shadow-sm' : 'text-zinc-400'}">
            ${isFilled ? sabor : 'Vacío'}
          </span>
        </div>`;
    }
    
    updateFlavorButtonsUI();

    const confirmBtn = document.getElementById('confirm-special');
    if(config.seleccionados.length === config.max) {
      confirmBtn.classList.remove('opacity-50', 'pointer-events-none');
    } else {
      confirmBtn.classList.add('opacity-50', 'pointer-events-none');
    }
  }

  // 4. CLICK EN SABOR
  document.querySelectorAll('.flavor-station-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if(config.seleccionados.length < config.max) {
        config.seleccionados.push(btn.dataset.name);
        renderSlots();
      } else {
         btn.style.transform = 'translateX(5px)';
         setTimeout(() => btn.style.transform = 'translateX(0)', 100);
      }
    });
  });

  // 5. BORRAR ÚLTIMO
  document.getElementById('undo-selection').addEventListener('click', () => {
    config.seleccionados.pop();
    renderSlots();
  });

  // 6. CERRAR MODAL
  document.getElementById('close-stations').addEventListener('click', () => {
    document.getElementById('stations-modal').classList.add('hidden');
  });

  // ==========================================
  // 7. LÓGICA DE AGREGAR AL CARRITO (NUEVO)
  // ==========================================
  document.getElementById('confirm-special').addEventListener('click', () => {
    // 1. Construimos la descripción de los sabores elegidos
    let descripcionPedido = `Estaciones: ${config.seleccionados.join(', ')}`;
    
    // Si hay un regalo en el dataset, lo agregamos
    if(config.regalo && config.regalo !== "undefined" && config.regalo !== "") {
        descripcionPedido += ` + Regalo: ${config.regalo}`;
    }

    // 2. Creamos el objeto del producto
    const nuevoItem = {
        id: Date.now(), // ID único basado en el tiempo
        nombre: config.nombre,
        precio: config.precio,
        descripcion: descripcionPedido,
        cantidad: 1,
        imagen: '/images/pizza-icon-default.png' // Puedes cambiar esto si tienes iconos
    };

    // 3. Nos aseguramos que exista el carrito y agregamos
    window.cart = window.cart || [];
    window.cart.push(nuevoItem);

    // 4. Actualizamos el Navbar (Llama a la función global definida en Navbar.astro)
    if (typeof window.updateCartUI === 'function') {
        window.updateCartUI();
        
        // Efecto visual opcional: Agitar el icono del carrito
        const cartBtn = document.getElementById('open-cart');
        if(cartBtn) {
            cartBtn.classList.add('scale-110', 'bg-roger-green');
            setTimeout(() => cartBtn.classList.remove('scale-110', 'bg-roger-green'), 300);
        }
    } else {
        console.warn('La función updateCartUI no está disponible.');
    }

    // 5. Cerramos el modal y limpiamos
    document.getElementById('stations-modal').classList.add('hidden');
    config.seleccionados = []; // Limpiar para la próxima
    renderSlots();
    
    // Opcional: Feedback al usuario (alerta simple o console log)
    console.log("Producto agregado:", nuevoItem);
  });
</script>

<style>
  @keyframes popIn {
    0% { opacity: 0; transform: scale(0.9) translateY(20px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
  }
  .animate-pop-in { animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

  .custom-scrollbar::-webkit-scrollbar { width: 5px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 10px; }
  .custom-scrollbar:hover::-webkit-scrollbar-thumb { background: #a1a1aa; }
</style>