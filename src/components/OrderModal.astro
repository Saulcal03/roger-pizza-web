---
// OrderModal.astro
---
<div id="order-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-zinc-900/60 backdrop-blur-sm">
  <div class="bg-white w-full max-w-lg rounded-[2.5rem] p-8 md:p-10 shadow-2xl overflow-y-auto max-h-[90vh] relative border border-zinc-100">
    
    <button id="close-modal" class="absolute top-8 right-8 text-zinc-400 hover:text-zinc-900 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>

    <div class="mb-10 flex justify-between items-end">
      <div>
        <span class="text-roger-green font-bold tracking-[0.2em] uppercase text-[10px]">Revisa tu selecci√≥n</span>
        <h2 class="text-4xl font-black italic uppercase text-zinc-900 leading-none mt-2">Tu Pedido</h2>
      </div>
      <button id="clear-cart-btn" class="text-[9px] font-bold text-red-400 hover:text-red-600 uppercase tracking-widest border-b border-red-100 pb-1 transition-all">
        Limpiar Carrito
      </button>
    </div>

    <div class="space-y-4 mb-8">
      <div id="cart-items-list" class="space-y-4 text-left">
        </div>

      <div class="mt-8 pt-6 border-t border-dashed border-zinc-200 flex justify-between items-end">
        <div>
          <p class="text-[10px] font-black uppercase tracking-widest text-zinc-400">Total a Pagar</p>
          <p id="pizza-price" class="text-5xl font-black text-zinc-900 leading-none italic mt-1 tracking-tighter">$0.00</p>
        </div>
        <div class="text-right flex flex-col items-end">
          <span class="bg-roger-green/10 text-roger-green text-[10px] font-black px-4 py-1.5 rounded-full uppercase italic leading-none">C√≥mputo Autom√°tico</span>
        </div>
      </div>
    </div>

    <form id="order-form" class="space-y-6">
      <div class="grid grid-cols-1 gap-4 text-left">
        <div class="space-y-2">
          <label class="text-[10px] font-black uppercase tracking-widest text-zinc-400 ml-2">Nombre Completo</label>
          <input type="text" required name="nombre" placeholder="¬øA nombre de qui√©n?" class="w-full bg-zinc-50 border border-zinc-100 rounded-2xl p-4 text-zinc-900 focus:bg-white focus:border-roger-green outline-none transition-all" />
        </div>
        <div class="space-y-2">
          <label class="text-[10px] font-black uppercase tracking-widest text-zinc-400 ml-2">Direcci√≥n de Entrega</label>
          <input type="text" required name="direccion" placeholder="Calle, n√∫mero y referencias" class="w-full bg-zinc-50 border border-zinc-100 rounded-2xl p-4 text-zinc-900 focus:bg-white focus:border-roger-green outline-none transition-all" />
        </div>
        <div class="space-y-2">
          <label class="text-[10px] font-black uppercase tracking-widest text-zinc-400 ml-2 italic">Notas Extras</label>
          <textarea name="notas" placeholder="Instrucciones adicionales..." class="w-full bg-zinc-50 border border-zinc-100 rounded-2xl p-4 text-zinc-900 focus:bg-white focus:border-roger-green outline-none transition-all resize-none h-24"></textarea>
        </div>
      </div>
      <button type="submit" class="w-full bg-roger-green hover:bg-zinc-900 text-white font-black py-6 rounded-[2.2rem] transition-all shadow-xl shadow-roger-green/20 uppercase italic text-sm tracking-[0.2em] mt-4">
        Confirmar por WhatsApp
      </button>
    </form>
  </div>
</div>

<script is:inline>
  window.cart = window.cart || [];

  const closeModal = () => {
    document.getElementById('order-modal')?.classList.add('hidden');
    document.body.style.overflow = 'auto';
  };

  document.getElementById('close-modal')?.addEventListener('click', closeModal);

  document.getElementById('clear-cart-btn')?.addEventListener('click', () => {
    if (confirm("¬øVaciar carrito?")) {
      window.cart = [];
      closeModal();
      window.updateCartUI();
    }
  });

  window.updateQty = function(index, delta) {
    if (delta === -1) {
      window.cart.splice(index, 1);
    }
    if (window.cart.length === 0) closeModal();
    window.updateCartUI();
  };

  window.updateCartUI = function() {
    const list = document.getElementById('cart-items-list');
    const priceDisplay = document.getElementById('pizza-price');
    const counter = document.getElementById('cart-counter');

    if (!list) return;
    if (window.cart.length === 0) {
      list.innerHTML = `<p class="text-center text-zinc-400 py-12 font-bold uppercase text-[10px]">Carrito Vac√≠o</p>`;
      if (priceDisplay) priceDisplay.innerText = "$0.00";
      if (counter) counter.innerText = "0";
      return;
    }

    const groups = {};
    const specials = [];

    // Separar por tipo de producto
    window.cart.forEach((item, index) => {
      if (item.tam === "Especial") {
        specials.push({ ...item, originalIndex: index });
      } else {
        if (!groups[item.tam]) groups[item.tam] = [];
        const cleanName = item.nombre.replace('Pizza Individual: ', '').replace('Combo 2x1: ', '');
        const base = item.nombre.includes('Individual') ? item.precio / 0.6 : item.precio;
        groups[item.tam].push({ nombre: cleanName, precioBase: base, originalIndex: index });
      }
    });

    let html = "";
    let total = 0;

    // Renderizar Combos e Individuales normales
    for (const tam in groups) {
      const pizzas = groups[tam];
      pizzas.sort((a, b) => b.precioBase - a.precioBase);

      while (pizzas.length >= 2) {
        const p1 = pizzas.shift();
        const p2 = pizzas.shift();
        const precioCombo = Math.max(p1.precioBase, p2.precioBase);
        total += precioCombo;
        html += `
          <div class="flex flex-col bg-zinc-50 p-5 rounded-[2rem] border-2 border-roger-green/20 mb-3 relative">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <p class="font-black text-zinc-900 text-[11px] uppercase italic">Combo 2x1: ${tam}</p>
                <p class="text-[9px] text-zinc-500 font-bold mt-1 uppercase">${p1.nombre} + ${p2.nombre}</p>
              </div>
              <div class="flex flex-col items-end gap-2">
                <p class="font-black text-zinc-900 italic text-sm">$${precioCombo.toFixed(2)}</p>
                <button onclick="updateQty(${p1.originalIndex}, -1)" class="text-zinc-300 hover:text-red-500 transition-colors">üóëÔ∏è</button>
              </div>
            </div>
          </div>`;
      }

      if (pizzas.length === 1) {
        const p = pizzas.shift();
        const precioInd = Math.round(p.precioBase * 0.6);
        total += precioInd;
        html += `
          <div class="flex justify-between items-center bg-zinc-50 p-5 rounded-[2rem] border border-zinc-100 mb-3">
            <div class="flex-1">
              <p class="font-black text-zinc-900 text-[11px] uppercase italic">Pizza Individual: ${p.nombre}</p>
              <p class="text-[9px] text-zinc-400 font-bold uppercase">${tam}</p>
            </div>
            <div class="flex items-center gap-4">
              <p class="font-black text-zinc-900 italic text-sm">$${precioInd.toFixed(2)}</p>
              <button onclick="updateQty(${p.originalIndex}, -1)" class="text-zinc-300 hover:text-red-500 transition-colors">üóëÔ∏è</button>
            </div>
          </div>`;
      }
    }

    // --- RENDERIZADO DE ESPECIALIDADES ---
    specials.forEach((item) => {
      const sub = item.precio * item.cantidad;
      total += sub;
      html += `
        <div class="flex flex-col bg-zinc-900 text-white p-6 rounded-[2.5rem] mb-3 shadow-xl relative overflow-hidden">
          <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
              <p class="font-black text-[12px] uppercase italic leading-tight">${item.nombre}</p>
              <div class="flex items-center gap-2 mt-2">
                <span class="text-[14px]">üéÅ</span>
                <p class="text-[9px] text-roger-green font-black uppercase tracking-widest italic">${item.regalo || 'Refresco Gratis'}</p>
              </div>
            </div>
            <div class="flex flex-col items-end gap-2">
               <p class="font-black italic text-sm">$${sub.toFixed(2)}</p>
               <button onclick="updateQty(${item.originalIndex}, -1)" class="w-8 h-8 flex items-center justify-center bg-zinc-800 rounded-full text-zinc-500 hover:text-red-400 transition-colors">üóëÔ∏è</button>
            </div>
          </div>
        </div>`;
    });

    list.innerHTML = html;
    if (priceDisplay) priceDisplay.innerText = `$${total.toFixed(2)}`;
    if (counter) counter.innerText = window.cart.length;
  };

  document.getElementById('order-form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const total = document.getElementById('pizza-price').innerText;
    let detalle = "";
    
    document.querySelectorAll('#cart-items-list > div').forEach(div => {
      const titulo = div.querySelector('p')?.innerText;
      const subInfo = div.querySelector('p:nth-child(2)')?.innerText || "";
      const precio = div.querySelector('p.italic')?.innerText || "";
      detalle += `‚Ä¢ *${titulo}*%0A  _${subInfo}_  -> ${precio}%0A%0A`;
    });

    const mensaje = `*NUEVO PEDIDO - ROGER PIZZAS*%0Aüë§ *Cliente:* ${formData.get('nombre')}%0Aüìç *Dir:* ${formData.get('direccion')}%0Aüçï *DETALLE:*%0A${detalle}üí∞ *TOTAL: ${total}*`;
    window.open(`https://wa.me/2721318273?text=${mensaje}`, '_blank');
  });
</script>